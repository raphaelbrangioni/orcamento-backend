name: ğŸ¥ Health Check & Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  KUBE_NAMESPACE: orcamento

jobs:
  health-check:
    name: ğŸ” Application Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Setup Kubernetes
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      run: |
        mkdir -p ~/.kube
        echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
        
    - name: ğŸ¥ Check Backend Health
      id: backend-health
      run: |
        # Check if backend pods are running
        BACKEND_PODS=$(kubectl get pods -n $KUBE_NAMESPACE -l app=orcamento-backend --no-headers | wc -l)
        BACKEND_READY=$(kubectl get pods -n $KUBE_NAMESPACE -l app=orcamento-backend --no-headers | grep "Running" | wc -l)
        
        echo "Backend pods: $BACKEND_PODS"
        echo "Backend ready: $BACKEND_READY"
        
        if [ "$BACKEND_READY" -eq 0 ]; then
          echo "âŒ Backend is not healthy!"
          echo "BACKEND_STATUS=unhealthy" >> $GITHUB_OUTPUT
          kubectl describe pods -n $KUBE_NAMESPACE -l app=orcamento-backend
        else
          echo "âœ… Backend is healthy!"
          echo "BACKEND_STATUS=healthy" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ¥ Check Frontend Health
      id: frontend-health
      run: |
        # Check if frontend pods are running
        FRONTEND_PODS=$(kubectl get pods -n $KUBE_NAMESPACE -l app=orcamento-frontend --no-headers | wc -l)
        FRONTEND_READY=$(kubectl get pods -n $KUBE_NAMESPACE -l app=orcamento-frontend --no-headers | grep "Running" | wc -l)
        
        echo "Frontend pods: $FRONTEND_PODS"
        echo "Frontend ready: $FRONTEND_READY"
        
        if [ "$FRONTEND_READY" -eq 0 ]; then
          echo "âŒ Frontend is not healthy!"
          echo "FRONTEND_STATUS=unhealthy" >> $GITHUB_OUTPUT
          kubectl describe pods -n $KUBE_NAMESPACE -l app=orcamento-frontend
        else
          echo "âœ… Frontend is healthy!"
          echo "FRONTEND_STATUS=healthy" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸŒ Check Ingress Status
      run: |
        echo "ğŸ” Checking Ingress status..."
        kubectl get ingress -n $KUBE_NAMESPACE
        kubectl describe ingress -n $KUBE_NAMESPACE
        
    - name: ğŸ“Š Resource Usage
      run: |
        echo "ğŸ“Š Resource usage:"
        kubectl top pods -n $KUBE_NAMESPACE || echo "Metrics server not available"
        kubectl get pods -n $KUBE_NAMESPACE -o wide
        
    - name: ğŸš¨ Alert on Failure
      if: steps.backend-health.outputs.BACKEND_STATUS == 'unhealthy' || steps.frontend-health.outputs.FRONTEND_STATUS == 'unhealthy'
      run: |
        echo "ğŸš¨ ALERT: Application health check failed!"
        echo "Backend status: ${{ steps.backend-health.outputs.BACKEND_STATUS }}"
        echo "Frontend status: ${{ steps.frontend-health.outputs.FRONTEND_STATUS }}"
        
        # Here you could add notifications to Slack, email, etc.
        # For now, we'll just fail the job to create a visible alert
        exit 1
        
    - name: âœ… Health Check Summary
      if: success()
      run: |
        echo "âœ… All systems healthy!"
        echo "ğŸ·ï¸ Timestamp: $(date)"
        echo "ğŸŒ Frontend: http://orcamento.local"
        echo "ğŸŒ Backend: http://api.orcamento.local"
